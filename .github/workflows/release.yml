name: ðŸš€ Release Zappy

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type de version Ã  crÃ©er'
        required: true
        default: 'resolution-bug'
        type: choice
        options:
          - 'nouvelle-version'    # Major version (v1.0.0 -> v2.0.0)
          - 'nouvelle-feature'    # Minor version (v1.0.0 -> v1.1.0)
          - 'resolution-bug'      # Patch version (v1.0.0 -> v1.0.1)
      pre_release:
        description: 'Marquer comme prÃ©-release'
        required: false
        default: false
        type: boolean

# Permissions nÃ©cessaires pour crÃ©er des releases et pousser des tags
permissions:
  contents: write
  actions: read
  pages: write
  id-token: write

env:
  TERM: xterm
  # Binaires Ã  inclure dans la release
  BINARIES: "zappy_gui zappy_server zappy_ai"
  # BibliothÃ¨ques statiques Ã  inclure
  LIBRARIES: "libgui.a libserver.a libraylib_cpp.a libraygui_cpp.a"
  # BibliothÃ¨ques dynamiques Ã  inclure
  DYNAMIC_LIBS: "libraygui.so libraylibcpp.so"

jobs:
  check-permissions:
    name: ðŸ” VÃ©rifier les permissions
    runs-on: ubuntu-latest
    steps:
      - name: VÃ©rifier les droits de crÃ©ation de release
        run: |
          echo "ðŸ” VÃ©rification des permissions pour crÃ©er une release..."
          echo "ðŸ‘¤ Utilisateur: ${{ github.actor }}"
          echo "ðŸ“¦ Repository: ${{ github.repository }}"

  calculate-version:
    name: ðŸ“Š Calculer la nouvelle version
    runs-on: ubuntu-latest
    needs: check-permissions
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      previous_version: ${{ steps.version.outputs.previous_version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ RÃ©cupÃ©rer la derniÃ¨re version
        id: get_latest_tag
        run: |
          # RÃ©cupÃ©rer le dernier tag qui suit le format semantic versioning
          latest_tag=$(git tag -l "v*.*.*" | sort -V | tail -n1)
          if [ -z "$latest_tag" ]; then
            echo "Aucun tag trouvÃ©, initialisation Ã  v0.0.0"
            latest_tag="v0.0.0"
          fi
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ DerniÃ¨re version trouvÃ©e: $latest_tag"

      - name: ðŸ§® Calculer la nouvelle version
        id: version
        run: |
          latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"
          
          # Extraire les numÃ©ros de version (retirer le 'v')
          version_numbers=${latest_tag#v}
          
          # SÃ©parer major, minor, patch
          IFS='.' read -r major minor patch <<< "$version_numbers"
          
          # Calculer la nouvelle version selon le type choisi
          case "${{ github.event.inputs.version_type }}" in
            "nouvelle-version")
              major=$((major + 1))
              minor=0
              patch=0
              echo "ðŸ†• Nouvelle version majeure"
              ;;
            "nouvelle-feature")
              minor=$((minor + 1))
              patch=0
              echo "âœ¨ Nouvelle fonctionnalitÃ©"
              ;;
            "resolution-bug")
              patch=$((patch + 1))
              echo "ðŸ› Correction de bug"
              ;;
          esac
          
          new_version="v${major}.${minor}.${patch}"
          
          echo "previous_version=$latest_tag" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          
          echo "ðŸ“ˆ Ã‰volution: $latest_tag â†’ $new_version"

      - name: ðŸ“ GÃ©nÃ©rer le changelog
        id: changelog
        run: |
          previous_version="${{ steps.version.outputs.previous_version }}"
          new_version="${{ steps.version.outputs.new_version }}"
          
          echo "GÃ©nÃ©ration du changelog depuis $previous_version..."
          
          # CrÃ©er un changelog basÃ© sur les commits depuis le dernier tag
          changelog_file=$(mktemp)
          
          echo "## ðŸŽ® Zappy $new_version" > $changelog_file
          echo "" >> $changelog_file
          echo "### ðŸ“… Date de release: $(date '+%d/%m/%Y Ã  %H:%M')" >> $changelog_file
          echo "" >> $changelog_file
          
          # Ajouter le type de release
          case "${{ github.event.inputs.version_type }}" in
            "nouvelle-version")
              echo "### ðŸ†• Nouvelle version majeure" >> $changelog_file
              echo "Cette version introduit des changements majeurs et peut contenir des breaking changes." >> $changelog_file
              ;;
            "nouvelle-feature")
              echo "### âœ¨ Nouvelle fonctionnalitÃ©" >> $changelog_file
              echo "Cette version ajoute de nouvelles fonctionnalitÃ©s tout en maintenant la compatibilitÃ©." >> $changelog_file
              ;;
            "resolution-bug")
              echo "### ðŸ› Correction de bugs" >> $changelog_file
              echo "Cette version corrige des bugs et amÃ©liore la stabilitÃ©." >> $changelog_file
              ;;
          esac
          
          echo "" >> $changelog_file
          echo "### ðŸ“‹ Changements" >> $changelog_file
          
          # Si c'est le premier tag
          if [ "$previous_version" = "v0.0.0" ]; then
            echo "- ðŸŽ‰ Release initiale du projet Zappy" >> $changelog_file
            echo "- ðŸ–¥ï¸ Serveur de jeu (zappy_server)" >> $changelog_file
            echo "- ðŸŽ¨ Interface graphique (zappy_gui)" >> $changelog_file
            echo "- ðŸ¤– Client IA (zappy_ai)" >> $changelog_file
          else
            # RÃ©cupÃ©rer les commits depuis le dernier tag
            git rev-list "$previous_version"..HEAD --oneline | head -20 | while read line; do
              echo "- $line" >> $changelog_file
            done
          fi
          
          echo "" >> $changelog_file
          echo "### ðŸ“¦ Contenu de la release" >> $changelog_file
          echo "- **Binaires**: zappy_server, zappy_gui, zappy_ai" >> $changelog_file
          echo "- **BibliothÃ¨ques**: libgui.a, libserver.a, libraylib_cpp.a, libraygui_cpp.a" >> $changelog_file
          echo "- **Plugins**: libraygui.so, libraylibcpp.so" >> $changelog_file
          echo "- **Documentation**: Guide d'utilisation et API" >> $changelog_file
          
          # Lire le contenu et l'encoder pour GitHub
          changelog_content=$(cat $changelog_file)
          
          # Utiliser un dÃ©limiteur pour le contenu multiline
          {
            echo 'changelog<<EOF'
            echo "$changelog_content"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          echo "ðŸ“ Changelog gÃ©nÃ©rÃ© avec succÃ¨s"

  build-release:
    name: ðŸ—ï¸ Compiler pour la release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: calculate-version
    outputs:
      artifact_name: ${{ steps.upload.outputs.artifact_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ“¦ Installer les dÃ©pendances
        timeout-minutes: 10
        run: |
          echo "ðŸ”§ Installation des dÃ©pendances systÃ¨me..."
          sudo apt-get update
          sudo apt-get install -y \
            make gcc g++ \
            libsfml-dev libcriterion-dev \
            build-essential cmake gcovr \
            libx11-dev libxcursor-dev libxrandr-dev \
            libxinerama-dev libxi-dev libgl1-mesa-dev \
            libglu1-mesa-dev libasound2-dev \
            libwayland-dev libxkbcommon-dev xorg-dev \
            python3 python3-pip
          
          echo "ðŸ“š Installation de Raylib..."
          git clone https://github.com/raysan5/raylib.git raylib
          cd raylib
          mkdir build && cd build
          cmake -DBUILD_SHARED_LIBS=ON -DUSE_EXTERNAL_GLFW=OFF -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)
          sudo make install
          cd ../..
          sudo ldconfig
          
          echo "ðŸ Installation des dÃ©pendances Python..."
          pip3 install --upgrade pip wheel setuptools

      - name: ðŸ—ï¸ Compiler le projet
        timeout-minutes: 15
        run: |
          echo "ðŸš€ Compilation de tous les composants..."
          make clean
          make all
          
          echo "âœ… Compilation terminÃ©e avec succÃ¨s"

      - name: ðŸ§ª Installer les dÃ©pendances IA
        run: |
          echo "ðŸ¤– Installation des dÃ©pendances IA..."
          make install_ai

      - name: âœ… VÃ©rifier les binaires
        run: |
          echo "ðŸ” VÃ©rification des binaires..."
          for binary in ${{ env.BINARIES }}; do
            if [ ! -f "./$binary" ]; then
              echo "âŒ Binaire $binary introuvable"
              exit 1
            elif [ ! -x "./$binary" ]; then
              echo "âŒ Binaire $binary non exÃ©cutable"
              exit 1
            else
              echo "âœ… Binaire $binary OK"
              ls -la "./$binary"
            fi
          done

      - name: âœ… VÃ©rifier les bibliothÃ¨ques
        run: |
          echo "ðŸ” VÃ©rification des bibliothÃ¨ques..."
          
          # BibliothÃ¨ques statiques
          for library in ${{ env.LIBRARIES }}; do
            if [ -f "./build/$library" ]; then
              echo "âœ… BibliothÃ¨que statique $library OK"
              ls -la "./build/$library"
            else
              echo "âš ï¸ BibliothÃ¨que statique $library introuvable"
            fi
          done
          
          # BibliothÃ¨ques dynamiques
          for library in ${{ env.DYNAMIC_LIBS }}; do
            if [ -f "./plugins/$library" ]; then
              echo "âœ… BibliothÃ¨que dynamique $library OK"
              ls -la "./plugins/$library"
            else
              echo "âš ï¸ BibliothÃ¨que dynamique $library introuvable"
            fi
          done

      - name: ðŸ“¦ PrÃ©parer l'archive de release
        id: prepare_archive
        run: |
          new_version="${{ needs.calculate-version.outputs.new_version }}"
          release_dir="zappy-$new_version"
          
          echo "ðŸ“ CrÃ©ation du rÃ©pertoire de release: $release_dir"
          mkdir -p "$release_dir"
          
          # Copier les binaires
          echo "ðŸ“‹ Copie des binaires..."
          for binary in ${{ env.BINARIES }}; do
            if [ -f "./$binary" ]; then
              cp "./$binary" "$release_dir/"
              echo "âœ… $binary copiÃ©"
            fi
          done
          
          # CrÃ©er les rÃ©pertoires pour les bibliothÃ¨ques
          mkdir -p "$release_dir/lib"
          mkdir -p "$release_dir/plugins"
          
          # Copier les bibliothÃ¨ques statiques
          echo "ðŸ“š Copie des bibliothÃ¨ques statiques..."
          for library in ${{ env.LIBRARIES }}; do
            if [ -f "./build/$library" ]; then
              cp "./build/$library" "$release_dir/lib/"
              echo "âœ… $library copiÃ©"
            fi
          done
          
          # Copier les bibliothÃ¨ques dynamiques
          echo "ðŸ”Œ Copie des bibliothÃ¨ques dynamiques..."
          for library in ${{ env.DYNAMIC_LIBS }}; do
            if [ -f "./plugins/$library" ]; then
              cp "./plugins/$library" "$release_dir/plugins/"
              echo "âœ… $library copiÃ©"
            fi
          done
          
          # Copier la documentation
          echo "ðŸ“– Copie de la documentation..."
          cp README.md "$release_dir/"
          
          # CrÃ©er un script d'installation
          cat > "$release_dir/install.sh" << 'EOF'
          #!/bin/bash
          echo "ðŸŽ® Installation de Zappy"
          echo "========================"

          # Copier les binaires
          echo "ðŸ“‹ Installation des binaires..."
          sudo cp zappy_* /usr/local/bin/
          sudo chmod +x /usr/local/bin/zappy_*

          # Copier les bibliothÃ¨ques
          echo "ðŸ“š Installation des bibliothÃ¨ques..."
          sudo cp lib/* /usr/local/lib/ 2>/dev/null || true
          sudo cp plugins/* /usr/local/lib/ 2>/dev/null || true
          sudo ldconfig

          echo "âœ… Installation terminÃ©e !"
          echo "ðŸ’¡ Utilisation:"
          echo "   zappy_server -p <port> -x <width> -y <height> -n <teams> -c <clients> -f <freq>"
          echo "   zappy_gui -p <port> -h <host>"
          echo "   zappy_ai -p <port> -n <team>"
          EOF
                chmod +x "$release_dir/install.sh"
                # CrÃ©er un fichier de version
                cat > "$release_dir/VERSION" << EOF
          $new_version
          EOF
                    
          # Afficher le contenu
          echo "ðŸ“‹ Contenu de la release:"
          find "$release_dir" -type f -exec ls -la {} \;
          
          # CrÃ©er l'archive
          echo "ðŸ—œï¸ CrÃ©ation de l'archive..."
          tar -czf "$release_dir.tar.gz" "$release_dir"
          
          echo "release_dir=$release_dir" >> $GITHUB_OUTPUT
          echo "archive_name=$release_dir.tar.gz" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload des artefacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: zappy-${{ needs.calculate-version.outputs.new_version }}
          path: ${{ steps.prepare_archive.outputs.archive_name }}
          retention-days: 90

  create-release:
    name: ðŸš€ CrÃ©er la release GitHub
    runs-on: ubuntu-latest
    needs: [calculate-version, build-release]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¥ TÃ©lÃ©charger les artefacts
        uses: actions/download-artifact@v4
        with:
          name: zappy-${{ needs.calculate-version.outputs.new_version }}

      - name: ðŸš€ CrÃ©er la release GitHub
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.calculate-version.outputs.new_version }}
          name: "ðŸŽ® Zappy ${{ needs.calculate-version.outputs.new_version }}"
          body: ${{ needs.calculate-version.outputs.changelog }}
          files: zappy-${{ needs.calculate-version.outputs.new_version }}.tar.gz
          prerelease: ${{ github.event.inputs.pre_release }}
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŽ‰ Release crÃ©Ã©e avec succÃ¨s
        run: |
          echo "ðŸŽ‰ Release ${{ needs.calculate-version.outputs.new_version }} crÃ©Ã©e avec succÃ¨s !"
          echo "ðŸ“¦ Archive: zappy-${{ needs.calculate-version.outputs.new_version }}.tar.gz"
          echo "ðŸ”— URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.calculate-version.outputs.new_version }}"
